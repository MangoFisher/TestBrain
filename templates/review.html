{% extends "base.html" %}
{% load static %}

{% block title %}TestBrain - 测试用例评审{% endblock %}

{% block content %}
{% csrf_token %}
<div class="card">
    <div class="card-header">
        测试用例评审
    </div>
    <div class="card-body">
        <ul class="nav nav-tabs" id="reviewTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="pending-tab" data-toggle="tab" href="#pending" role="tab">
                    待评审 <span class="badge badge-warning">{{ pending_test_cases|length }}</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="approved-tab" data-toggle="tab" href="#approved" role="tab">
                    已通过 <span class="badge badge-success">{{ approved_test_cases|length }}</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="rejected-tab" data-toggle="tab" href="#rejected" role="tab">
                    未通过 <span class="badge badge-danger">{{ rejected_test_cases|length }}</span>
                </a>
            </li>
        </ul>
        
        <div class="tab-content mt-3" id="reviewTabsContent">
            <!-- 待评审测试用例 -->
            <div class="tab-pane fade show active" id="pending" role="tabpanel">
                {% if pending_test_cases %}
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="thead-light">
                            <tr>
                                <th>状态</th>
                                <th>用例描述</th>
                                <th>测试步骤</th>
                                <th>预期结果</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for test_case in pending_test_cases %}
                            <tr>
                                <td><span class="badge badge-warning">待评审</span></td>
                                <td>{{ test_case.description }}</td>
                                <td>{{ test_case.test_steps|safe }}</td>
                                <td>{{ test_case.expected_results|safe }}</td>
                                <td>
                                    <button class="btn btn-primary btn-sm review-button" data-id="{{ test_case.id }}">AI评审</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                    <div class="alert alert-info">没有待评审的测试用例</div>
                {% endif %}
            </div>
            
            <!-- 已通过测试用例 -->
            <div class="tab-pane fade" id="approved" role="tabpanel">
                {% if approved_test_cases %}
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="thead-light">
                            <tr>
                                <th style="width: 40px;">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="select-all">
                                        <label class="custom-control-label" for="select-all"></label>
                                    </div>
                                </th>
                                <th>状态</th>
                                <th>用例描述</th>
                                <th>测试步骤</th>
                                <th>预期结果</th>
                                <th>评审意见</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for test_case in approved_test_cases %}
                            <tr>
                                <td>
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input case-checkbox" 
                                               id="case-{{ test_case.id }}" data-id="{{ test_case.id }}">
                                        <label class="custom-control-label" for="case-{{ test_case.id }}"></label>
                                    </div>
                                </td>
                                <td><span class="badge badge-success">已通过</span></td>
                                <td>{{ test_case.description }}</td>
                                <td>{{ test_case.test_steps|safe }}</td>
                                <td>{{ test_case.expected_results|safe }}</td>
                                <td>
                                    {% if test_case.reviews.exists %}
                                        {{ test_case.reviews.last.review_comments }}
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- 只在已通过标签页中添加操作按钮 -->
                <div class="mt-3">
                    <button id="copy-selected" class="btn btn-primary mr-2">复制</button>
                    <button id="export-excel" class="btn btn-success">导出到Excel</button>
                </div>
                
                {% else %}
                    <div class="alert alert-info">没有评审通过的测试用例</div>
                {% endif %}
            </div>
            
            <!-- 未通过测试用例 -->
            <div class="tab-pane fade" id="rejected" role="tabpanel">
                {% if rejected_test_cases %}
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="thead-light">
                            <tr>
                                <th>状态</th>
                                <th>用例描述</th>
                                <th>测试步骤</th>
                                <th>预期结果</th>
                                <th>评审意见</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for test_case in rejected_test_cases %}
                            <tr>
                                <td><span class="badge badge-danger">未通过</span></td>
                                <td>{{ test_case.description }}</td>
                                <td>{{ test_case.test_steps|safe }}</td>
                                <td>{{ test_case.expected_results|safe }}</td>
                                <td>
                                    {% if test_case.reviews.exists %}
                                        {{ test_case.reviews.last.review_comments }}
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-primary btn-sm review-button" data-id="{{ test_case.id }}">重新评审</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                    <div class="alert alert-info">没有评审未通过的测试用例</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/review.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 全选功能
    const selectAllCheckbox = document.getElementById('select-all');
    const caseCheckboxes = document.querySelectorAll('.case-checkbox');
    
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            caseCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
    }
    
    caseCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (!this.checked && selectAllCheckbox) {
                selectAllCheckbox.checked = false;
            } else if (Array.from(caseCheckboxes).every(cb => cb.checked) && selectAllCheckbox) {
                selectAllCheckbox.checked = true;
            }
        });
    });
    
    // 复制按钮功能
    document.getElementById('copy-selected').addEventListener('click', function() {
        const selectedIds = Array.from(document.querySelectorAll('.case-checkbox:checked'))
            .map(checkbox => checkbox.getAttribute('data-id'));
            
        if (selectedIds.length === 0) {
            alert('请先选择要复制的测试用例');
            return;
        }
        
        // 复制选中的测试用例
        fetch('/api/copy-test-cases/?ids=' + selectedIds.join(','), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 将测试用例数据格式化为文本
            const textToCopy = data.test_cases.map(testCase => {
                return `测试用例描述：${testCase.description}\n` +
                       `测试步骤：${testCase.test_steps}\n` +
                       `预期结果：${testCase.expected_results}\n` +
                       `----------------------------------------`;
            }).join('\n\n');
            
            // 复制到剪贴板
            navigator.clipboard.writeText(textToCopy)
                .then(() => {
                    alert('测试用例已复制到剪贴板！');
                })
                .catch(err => {
                    console.error('复制到剪贴板失败:', err);
                    alert('复制到剪贴板失败，请手动复制：\n\n' + textToCopy);
                });
            } else {
                alert('复制失败：' + data.message);
            }
        })
        .catch(error => {
            console.error('复制失败:', error);
            alert('复制失败，请查看控制台获取详细信息');
        });
    });
    
    // 导出到Excel按钮功能
    document.getElementById('export-excel').addEventListener('click', function() {
        const selectedIds = Array.from(document.querySelectorAll('.case-checkbox:checked'))
            .map(checkbox => checkbox.getAttribute('data-id'));
            
        if (selectedIds.length === 0) {
            alert('请先选择要导出的测试用例');
            return;
        }
        
        // 导出选中的测试用例到Excel
        window.location.href = '/api/export-test-cases-excel/?ids=' + selectedIds.join(',');
    });
});
</script>
{% endblock %} 