<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TestBrain - 测试用例详细评审</title>
    <!-- 引入 Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
    <!-- 自定义样式 -->
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        textarea {
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">测试用例详细评审</h5>
            </div>
            <div class="card-body">
                <form id="caseReviewForm">
                    <div class="form-group">
                        <label for="status">状态</label>
                        <select class="form-control" id="status" name="status">
                            <option value="pending">待评审</option>
                            <option value="approved">评审通过</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="description">用例描述</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="test_steps">测试步骤</label>
                        <textarea class="form-control" id="test_steps" name="test_steps" rows="5"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="expected_results">预期结果</label>
                        <textarea class="form-control" id="expected_results" name="expected_results" rows="5"></textarea>
                    </div>
                    <input type="hidden" id="test_case_id" name="test_case_id">
                </form>
            </div>
            <div class="card-footer text-right">
                <button type="button" class="btn btn-primary" id="startReviewBtn">开始评审</button>
                <button type="button" class="btn btn-success" id="saveBtn">保存</button>
            </div>
        </div>
    </div>

    <!-- 引入 jQuery 和 Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
    // 获取CSRF Token的辅助函数
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // 页面加载完成后自动填充数据
    document.addEventListener('DOMContentLoaded', function() {
        // 从URL获取测试用例ID
        const urlParams = new URLSearchParams(window.location.search);
        const testCaseId = urlParams.get('id');
        
        if (testCaseId) {
            // 获取测试用例数据
            fetch(`/api/test-case/${testCaseId}/`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('test_case_id').value = data.id;
                document.getElementById('description').value = data.description;
                document.getElementById('test_steps').value = data.test_steps;
                document.getElementById('expected_results').value = data.expected_results;
                
                // 正确设置状态下拉框的值
                const statusSelect = document.getElementById('status');
                for(let i = 0; i < statusSelect.options.length; i++) {
                    if(statusSelect.options[i].value === data.status) {
                        statusSelect.selectedIndex = i;
                        break;
                    }
                }
                
                console.log('加载的状态值:', data.status);
            })
            .catch(error => {
                console.error('获取测试用例数据失败:', error);
                alert('获取测试用例数据失败，请查看控制台获取详细信息');
            });
        }
        
        // 绑定按钮事件
        document.getElementById('startReviewBtn').onclick = function() {
            startAIReview(testCaseId);
        };
        
        document.getElementById('saveBtn').onclick = function() {
            saveTestCase();
        };
    });

    function startAIReview(testCaseId) {
        fetch('/api/review/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                test_case_id: testCaseId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('AI评审完成！');
                window.close();
                window.opener.location.reload();
            } else {
                alert('评审失败：' + data.message);
            }
        })
        .catch(error => {
            console.error('评审请求失败:', error);
            alert('评审请求失败，请查看控制台获取详细信息');
        });
    }

    function saveTestCase() {
        const form = document.getElementById('caseReviewForm');
        const formData = {
            test_case_id: form.test_case_id.value,
            status: form.status.value,
            description: form.description.value,
            test_steps: form.test_steps.value,
            expected_results: form.expected_results.value
        };

        fetch('/api/update-test-case/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('保存成功！');
                window.close();
                window.opener.location.reload();
            } else {
                alert('保存失败：' + data.message);
            }
        })
        .catch(error => {
            console.error('保存失败:', error);
            alert('保存失败，请查看控制台获取详细信息');
        });
    }
    </script>
</body>
</html> 